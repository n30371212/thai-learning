<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPTFL æ³°èªå…¨èƒ½ç‰¹è¨“ v7 (XPç³»çµ±ç‰ˆ)</title>
    
    <!-- æ ¸å¿ƒå‡½å¼åº« -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./vocab-data.js"></script>

    <style>
        /* ç¿»ç‰Œå‹•ç•« */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* å­éŸ³é¡åˆ¥é¡è‰² */
        .class-mid { border-color: #16a34a; background-color: #f0fdf4; color: #16a34a; }
        .class-high { border-color: #dc2626; background-color: #fef2f2; color: #dc2626; }
        .class-low { border-color: #2563eb; background-color: #eff6ff; color: #2563eb; }
        
        /* æ¯éŸ³é¡åˆ¥é¡è‰² */
        .vowel-short { border-color: #f59e0b; background-color: #fffbeb; color: #92400e; }
        .vowel-long { border-color: #8b5cf6; background-color: #f5f3ff; color: #5b21b6; }
        .vowel-special { border-color: #ec4899; background-color: #fdf2f8; color: #9d174d; }

        /* è€ƒè©¦å€’æ•¸å‹•ç•« */
        @keyframes pulse-red {
            0%, 100% { color: #ef4444; }
            50% { color: #7f1d1d; }
        }
        .animate-timer { animation: pulse-red 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* XP æµ®å‹•å‹•ç•« */
        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        .animate-float-up { animation: float-up 1s ease-out forwards; }
    </style>
</head>
<body class="bg-yellow-50 text-gray-800 h-screen overflow-hidden font-sans select-none">

    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 0. å…¨åŸŸå·¥å…·å‡½å¼ ---
        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        const playAudio = (text) => {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'th-TH'; 
            utterance.rate = 0.8; 
            window.speechSynthesis.speak(utterance);
        };

        // --- 1. è³‡æ–™åº« (å¤–éƒ¨è¼‰å…¥) ---
        const {
            rawVocabData = [],
            consonantData = [],
            vowelData = []
        } = window.taiData || {};

        // --- 2. å„å€‹åŠŸèƒ½é é¢å…ƒä»¶ ---

        // [é é¢] é¦–é  (åŒ…å« XP å„€è¡¨æ¿)
        const HomeScreen = ({ onStart, xp, level }) => {
            // è¨ˆç®—ä¸‹ä¸€ç´šéœ€è¦çš„ XP (å–é¤˜æ•¸)
            const progress = xp % 100;

            return (
                <div className="flex flex-col items-center h-full p-4 animate-fade-in bg-yellow-50 overflow-y-auto">
                    <div className="text-center mt-6 mb-4">
                        <h1 className="text-4xl md:text-5xl font-extrabold text-yellow-600 mb-2">ğŸ‡¹ğŸ‡­ CPTFL ç‰¹è¨“</h1>
                        <p className="text-gray-500">Gamification Edition v7</p>
                    </div>

                    {/* XP å„€è¡¨æ¿ */}
                    <div className="w-full max-w-md bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-4 text-white shadow-lg mb-6 relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-20">
                            <svg className="w-24 h-24" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 12H9v-2h2v2zm0-4H9V5h2v5z"/></svg>
                        </div>
                        <div className="relative z-10 flex justify-between items-end mb-2">
                            <div>
                                <div className="text-indigo-200 text-xs font-bold uppercase tracking-wider">Current Level</div>
                                <div className="text-4xl font-black flex items-baseline gap-1">
                                    <span className="text-xl">Lv.</span>{level}
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-indigo-200 text-xs font-bold uppercase tracking-wider">Total XP</div>
                                <div className="text-2xl font-bold">{xp}</div>
                            </div>
                        </div>
                        {/* é€²åº¦æ¢ */}
                        <div className="relative w-full h-3 bg-black/30 rounded-full overflow-hidden">
                            <div className="absolute top-0 left-0 h-full bg-yellow-400 transition-all duration-500" style={{ width: `${progress}%` }}></div>
                        </div>
                        <div className="flex justify-between text-[10px] mt-1 text-indigo-200 font-mono">
                            <span>{progress} / 100 XP to next level</span>
                            <span>{100 - progress} XP left</span>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-md pb-8">
                        {/* å­¸ç¿’å€ */}
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <h3 className="text-gray-400 text-xs uppercase tracking-wider mb-2 font-bold">åŸºç¤å­¸ç¿’</h3>
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => onStart('learn')} className="p-3 bg-blue-50 text-blue-700 rounded-lg font-bold hover:bg-blue-100 transition">å–®å­—å¡ (æœå°‹)</button>
                                <button onClick={() => onStart('rules')} className="p-3 bg-purple-50 text-purple-700 rounded-lg font-bold hover:bg-purple-100 transition">è²èª¿è¡¨</button>
                                <button onClick={() => onStart('alphabet')} className="p-3 bg-pink-50 text-pink-700 rounded-lg font-bold hover:bg-pink-100 transition col-span-2">å­—æ¯ç™¼éŸ³</button>
                            </div>
                        </div>

                        {/* æ¸¬é©—å€ */}
                        <div className="bg-white p-4 rounded-2xl shadow-lg border-2 border-yellow-400 relative overflow-hidden">
                            <div className="absolute top-0 right-0 bg-yellow-400 text-white text-xs px-2 py-1 rounded-bl-lg font-bold">Earn XP!</div>
                            <h3 className="text-yellow-600 text-xs uppercase tracking-wider mb-2 font-bold">æ¸¬é©—æ¨¡å¼</h3>
                            <div className="space-y-2">
                                <button onClick={() => onStart('quiz')} className="w-full p-3 bg-green-50 text-green-700 rounded-lg font-bold hover:bg-green-100 transition flex justify-between items-center group">
                                    <span>éš¨æ©Ÿç·´ç¿’</span> <span className="text-xs bg-green-200 px-2 py-0.5 rounded text-green-800 font-mono">+10 XP</span>
                                </button>
                                <button onClick={() => onStart('examIntro')} className="w-full p-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition shadow-md flex justify-between items-center group">
                                    <span>ğŸ† å¯¦æˆ°æ¨¡æ“¬è€ƒ</span> <span className="text-xs bg-white/20 px-2 py-0.5 rounded group-hover:bg-white/30 font-mono">+100 XP</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // [é é¢] å­—æ¯è¡¨
        const AlphabetScreen = ({ onBack }) => {
            const [tab, setTab] = useState('consonant'); 
            return (
                <div className="flex flex-col h-full max-w-3xl mx-auto p-4 bg-white">
                    <div className="flex items-center justify-between mb-4">
                         <button onClick={onBack} className="text-gray-500 hover:bg-gray-100 px-3 py-1 rounded">â¬…ï¸ é¦–é </button>
                         <div className="bg-gray-200 p-1 rounded-lg flex text-sm">
                            <button onClick={() => setTab('consonant')} className={`px-4 py-1 rounded-md transition ${tab === 'consonant' ? 'bg-white shadow text-yellow-700 font-bold' : 'text-gray-500'}`}>å­éŸ³</button>
                            <button onClick={() => setTab('vowel')} className={`px-4 py-1 rounded-md transition ${tab === 'vowel' ? 'bg-white shadow text-yellow-700 font-bold' : 'text-gray-500'}`}>æ¯éŸ³</button>
                         </div>
                    </div>
                    <div className="flex-1 overflow-y-auto grid grid-cols-4 md:grid-cols-6 gap-2 pb-4 content-start">
                        {tab === 'consonant' ? (
                            consonantData.map((item, idx) => (
                                <button key={idx} onClick={() => playAudio(item.char)} className={`p-2 rounded-xl border-2 flex flex-col items-center justify-center aspect-square hover:scale-105 transition shadow-sm class-${item.class}`}>
                                    <span className="text-3xl font-bold mb-1">{item.char}</span>
                                    <span className="text-[10px] opacity-70">{item.name}</span>
                                </button>
                            ))
                        ) : (
                            vowelData.map((item, idx) => (
                                <button key={idx} onClick={() => playAudio(item.char.replace(/-/g, 'à¸­'))} className={`p-2 rounded-xl border-2 flex flex-col items-center justify-center aspect-square hover:scale-105 transition shadow-sm vowel-${item.type}`}>
                                    <span className="text-2xl font-bold mb-1">{item.char}</span>
                                    <span className="text-[10px] opacity-70 text-center leading-tight">{item.name}</span>
                                </button>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // [é é¢] è²èª¿è¦å‰‡
        const RulesScreen = ({ onBack }) => (
            <div className="max-w-4xl mx-auto h-full overflow-y-auto p-4 pb-10 bg-white">
                <button onClick={onBack} className="mb-4 text-gray-500 hover:bg-gray-100 px-3 py-1 rounded">â¬…ï¸ é¦–é </button>
                <div className="bg-white p-5 rounded-2xl shadow-sm mb-6 border border-gray-100">
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">1. æœ‰è²èª¿ç¬¦è™Ÿ (Tone Marks)</h2>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-center border-collapse">
                            <thead>
                                <tr className="bg-gray-100 text-gray-600">
                                    <th className="p-2 border text-left">å­éŸ³</th>
                                    <th className="p-2 border">à¹ˆ (Mai Ek)</th>
                                    <th className="p-2 border">à¹‰ (Mai Tho)</th>
                                    <th className="p-2 border bg-yellow-50">à¹Š (Tri)</th>
                                    <th className="p-2 border bg-yellow-50">à¹‹ (Chattawa)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td className="p-3 border font-bold text-green-600 text-left">ä¸­ (Mid)</td><td className="p-3 border">Low (2)</td><td className="p-3 border">Falling (3)</td><td className="p-3 border bg-green-50 font-bold">High (4)</td><td className="p-3 border bg-green-50 font-bold">Rising (5)</td></tr>
                                <tr><td className="p-3 border font-bold text-red-600 text-left">é«˜ (High)</td><td className="p-3 border">Low (2)</td><td className="p-3 border">Falling (3)</td><td className="p-3 border text-gray-300">-</td><td className="p-3 border text-gray-300">-</td></tr>
                                <tr><td className="p-3 border font-bold text-blue-600 text-left">ä½ (Low)</td><td className="p-3 border font-bold text-purple-600">Falling (3)</td><td className="p-3 border font-bold text-purple-600">High (4)</td><td className="p-3 border text-gray-300">-</td><td className="p-3 border text-gray-300">-</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );

        // [é é¢] å–®å­—å¡å­¸ç¿’ (å«æœå°‹)
        const LearnScreen = ({ onBack }) => {
            // 1. ç‹€æ…‹è¨­å®š
            const [cards, setCards] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [showPinyin, setShowPinyin] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [dataStatus, setDataStatus] = useState('loading'); // loading, success, error

            // 2. åˆå§‹åŒ–ï¼šå¼·åˆ¶é‡æ–°è®€å– window.taiData
            useEffect(() => {
                // å˜—è©¦è®€å–è³‡æ–™
                const loadData = () => {
                    const db = window.taiData || {};
                    const rawData = db.rawVocabData || [];
                    
                    if (rawData.length > 0) {
                        setCards(shuffleArray(rawData));
                        setDataStatus('success');
                    } else {
                        // å¦‚æœè®€ä¸åˆ°ï¼Œå¯èƒ½æ˜¯è¼‰å…¥é †åºå•é¡Œï¼Œè¨­å®šç‹€æ…‹ç‚ºéŒ¯èª¤
                        console.error("æ‰¾ä¸åˆ°å–®å­—è³‡æ–™ï¼Œè«‹ç¢ºèª vocab-data.js æ˜¯å¦æ­£ç¢ºè¼‰å…¥");
                        setDataStatus('error');
                    }
                };

                loadData();
            }, []);

            // 3. éæ¿¾æœå°‹é‚è¼¯ (å³æ™‚é‹ç®—)
            const filteredCards = cards.filter(card => {
                const keyword = searchTerm.trim().toLowerCase();
                if (!keyword) return true;
                return (
                    (card.thai && card.thai.toLowerCase().includes(keyword)) ||
                    (card.pinyin && card.pinyin.toLowerCase().includes(keyword)) ||
                    (card.meaning && card.meaning.toLowerCase().includes(keyword))
                );
            });

            // 4. è¨ˆç®—ç›®å‰é¡¯ç¤ºçš„å¡ç‰‡
            const safeIndex = filteredCards.length === 0 ? 0 : currentIndex % filteredCards.length;
            const card = filteredCards[safeIndex];

            // ç•¶æœå°‹é—œéµå­—æ”¹è®Šæ™‚ï¼Œé‡ç½®å›ç¬¬ä¸€å¼µ
            useEffect(() => {
                setCurrentIndex(0);
                setIsFlipped(false);
            }, [searchTerm]);

            const changeCard = (dir) => {
                setIsFlipped(false);
                setTimeout(() => {
                    setCurrentIndex((prev) => {
                        if (filteredCards.length === 0) return 0;
                        return (prev + dir + filteredCards.length) % filteredCards.length;
                    });
                }, 200);
            };

            // 5. éŒ¯èª¤è™•ç† UI
            if (dataStatus === 'loading') return <div className="h-full flex items-center justify-center">è¼‰å…¥è³‡æ–™åº«ä¸­...</div>;
            
            if (dataStatus === 'error') return (
                <div className="h-full flex flex-col items-center justify-center p-6 text-center">
                    <h3 className="text-xl font-bold text-red-500 mb-2">âš ï¸ è®€å–ä¸åˆ°è³‡æ–™åº«</h3>
                    <p className="text-gray-500 mb-4">è«‹ç¢ºèª vocab-data.js æª”æ¡ˆæ˜¯å¦å­˜åœ¨ä¸”å…§å®¹æ­£ç¢ºã€‚</p>
                    <button onClick={() => window.location.reload()} className="px-6 py-2 bg-blue-500 text-white rounded-full shadow">é‡æ–°æ•´ç†é é¢</button>
                </div>
            );

            return (
                <div className="flex flex-col h-full max-w-md mx-auto p-4 bg-white">
                    {/* æœå°‹æ¡†å€å¡Š */}
                    <div className="mb-2">
                        <div className="relative">
                            <span className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-4.35-4.35m0 0A7 7 0 104.65 4.65a7 7 0 0011.99 11.99z" /></svg>
                            </span>
                            <input 
                                type="text" 
                                value={searchTerm} 
                                onChange={e => setSearchTerm(e.target.value)} 
                                className="w-full py-2 pl-10 pr-4 rounded-full border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-200" 
                                placeholder="æœå°‹æ³°æ–‡/æ‹¼éŸ³/ä¸­æ–‡..." 
                            />
                        </div>
                        {/* Debug è³‡è¨Šï¼šè®“ä½ çŸ¥é“æœå°‹çµæœæœ‰å¹¾ç­† */}
                        <div className="text-xs text-gray-400 text-center mt-1">
                            è³‡æ–™åº«ç¸½æ•¸: {cards.length} | æœå°‹çµæœ: {filteredCards.length}
                        </div>
                    </div>

                    <div className="flex justify-between items-center mb-2">
                        <button onClick={onBack} className="text-gray-500 hover:bg-gray-100 px-3 py-1 rounded">â¬…ï¸ é€€å‡º</button>
                        <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold">
                            {filteredCards.length === 0 ? 0 : safeIndex + 1} / {filteredCards.length}
                        </span>
                    </div>
                    
                    {/* å–®å­—å¡é¡¯ç¤ºå€ */}
                    <div className="flex-1 flex flex-col justify-center perspective-1000 my-2">
                        {filteredCards.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-80 text-gray-400 font-bold bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200">
                                <p>æ‰¾ä¸åˆ°ã€Œ{searchTerm}ã€</p>
                                <button onClick={() => setSearchTerm('')} className="mt-2 text-sm text-blue-500 underline">æ¸…é™¤æœå°‹</button>
                            </div>
                        ) : (
                            <div onClick={() => setIsFlipped(!isFlipped)} className={`relative w-full h-80 bg-gray-50 border-2 border-gray-100 rounded-3xl shadow-xl cursor-pointer transition-all duration-500 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                                <div className={`absolute inset-0 flex flex-col items-center justify-center backface-hidden p-6 ${isFlipped ? 'hidden' : 'flex'}`}>
                                    <span className="text-sm text-gray-400 uppercase tracking-wider mb-2">{card.category}</span>
                                    <h2 className="text-5xl font-bold text-gray-800 mb-4 text-center leading-tight">{card.thai}</h2>
                                    {showPinyin ? <p className="text-xl text-blue-500 font-medium">{card.pinyin}</p> : <div className="h-7 w-32 bg-gray-200 rounded animate-pulse"></div>}
                                    <button onClick={e => { e.stopPropagation(); playAudio(card.thai); }} className="mt-6 p-3 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-700 transition">ğŸ”Š</button>
                                </div>
                                <div className={`absolute inset-0 flex flex-col items-center justify-center backface-hidden p-6 bg-blue-50 rounded-3xl ${isFlipped ? 'flex' : 'hidden'}`} style={{ transform: 'rotateY(180deg)' }}>
                                    <h3 className="text-3xl font-bold text-gray-800 mb-2">{card.meaning}</h3>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="space-y-4">
                        <div className="flex justify-center gap-4">
                            <button onClick={() => changeCard(-1)} className="px-6 py-3 bg-gray-200 rounded-xl font-bold text-gray-600 disabled:opacity-50" disabled={filteredCards.length === 0}>ä¸Šä¸€å€‹</button>
                            <button onClick={() => changeCard(1)} className="px-6 py-3 bg-blue-500 rounded-xl font-bold text-white shadow-lg disabled:opacity-50" disabled={filteredCards.length === 0}>ä¸‹ä¸€å€‹</button>
                        </div>
                        <button onClick={() => setShowPinyin(!showPinyin)} className="w-full text-center text-sm text-gray-500 py-2" disabled={filteredCards.length === 0}>{showPinyin ? 'ğŸ‘ï¸ éš±è—æ‹¼éŸ³' : 'ğŸ‘ï¸â€ğŸ—¨ï¸ é¡¯ç¤ºæ‹¼éŸ³'}</button>
                    </div>
                </div>
            );
        };
        // [é é¢] éš¨æ©Ÿç·´ç¿’æ¸¬é©— (ç­”å°+10 XP)
        const PracticeQuizScreen = ({ onBack, addXp }) => {
            const [qIndex, setQIndex] = useState(0);
            const [questions] = useState(() => shuffleArray(rawVocabData));
            const [options, setOptions] = useState([]);
            const [selected, setSelected] = useState(null);
            const [showXpAnim, setShowXpAnim] = useState(false);
            
            useEffect(() => {
                if (qIndex < questions.length) {
                    const correct = questions[qIndex];
                    const others = rawVocabData.filter(d => d.id !== correct.id).sort(()=>0.5-Math.random()).slice(0,3);
                    setOptions(shuffleArray([...others, correct]));
                }
            }, [qIndex]);

            const handleAns = (meaning) => {
                playAudio(questions[qIndex].thai);
                setSelected(meaning);
                
                // åˆ¤æ–·æ˜¯å¦ç­”å°ï¼Œå¢åŠ  XP
                if (meaning === questions[qIndex].meaning) {
                    addXp(10);
                    setShowXpAnim(true);
                    setTimeout(() => setShowXpAnim(false), 1000);
                }

                setTimeout(() => {
                    if(qIndex < questions.length-1) { setQIndex(qIndex+1); setSelected(null); }
                    else { alert("ç·´ç¿’çµæŸï¼"); onBack(); }
                }, 1500);
            };

            if (qIndex >= questions.length) return null;

            return (
                <div className="flex flex-col h-full p-4 bg-green-50 max-w-md mx-auto relative overflow-hidden">
                   {/* XP å‹•ç•« (ç­”å°æ™‚å‡ºç¾) */}
                   {showXpAnim && (
                       <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 text-yellow-500 font-black text-4xl animate-float-up pointer-events-none drop-shadow-md">
                           +10 XP
                       </div>
                   )}

                   <button onClick={onBack} className="self-start text-gray-500 mb-4 hover:bg-green-100 px-3 py-1 rounded">â¬…ï¸ é€€å‡ºç·´ç¿’</button>
                   <div className="w-full bg-gray-200 h-2 rounded-full mb-4"><div className="bg-green-500 h-2 rounded-full transition-all" style={{width: `${(qIndex/questions.length)*100}%`}}></div></div>
                   
                   <div className="flex-1 flex flex-col justify-center text-center">
                        <h2 className="text-6xl font-bold text-green-800 mb-8">{questions[qIndex].thai}</h2>
                        <p className="text-gray-500 mb-6">é¸æ“‡æ­£ç¢ºæ„æ€</p>
                        <div className="grid gap-3">
                            {options.map((opt, i) => (
                                <button key={i} onClick={() => handleAns(opt.meaning)} disabled={selected!==null}
                                    className={`p-4 rounded-xl border-2 text-lg font-bold transition ${
                                        selected === null ? 'bg-white border-green-100 hover:border-green-400' :
                                        opt.meaning === questions[qIndex].meaning ? 'bg-green-500 text-white border-green-600' :
                                        opt.meaning === selected ? 'bg-red-500 text-white border-red-600' : 'bg-white opacity-30'
                                    }`}
                                >{opt.meaning}</button>
                            ))}
                        </div>
                   </div>
                </div>
            );
        };

        // [é é¢] æ¨¡æ“¬è€ƒ - è¦å‰‡
        const ExamIntroScreen = ({ onStart, onBack }) => (
            <div className="flex flex-col items-center justify-center h-full p-6 bg-gray-900 text-white">
                <div className="max-w-md text-center space-y-6 animate-fade-in">
                    <div className="text-6xl mb-4">âš ï¸</div>
                    <h2 className="text-3xl font-bold text-red-400">æ¨¡æ“¬è€ƒè¦å‰‡</h2>
                    <div className="text-left bg-gray-800 p-6 rounded-xl space-y-3 text-sm md:text-base border border-gray-700">
                        <p>â±ï¸ é™æ™‚ 5 åˆ†é˜ / 20 é¡Œ</p>
                        <p>ğŸš« ç„¡æ‹¼éŸ³è¼”åŠ©</p>
                        <p>ğŸ† <strong>åŠæ ¼ (60åˆ†) å¯ç²å¾— 100 XP</strong></p>
                    </div>
                    <div className="pt-6 flex gap-4 justify-center">
                        <button onClick={onBack} className="px-6 py-3 rounded-full border border-gray-600">æ”¾æ£„</button>
                        <button onClick={onStart} className="px-8 py-3 rounded-full bg-red-600 font-bold hover:bg-red-500 shadow-lg animate-pulse">é–‹å§‹è€ƒè©¦</button>
                    </div>
                </div>
            </div>
        );

        // [é é¢] æ¨¡æ“¬è€ƒ - é€²è¡Œä¸­
        const ExamScreen = ({ onFinish }) => {
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [userAnswers, setUserAnswers] = useState([]); 
            const [timeLeft, setTimeLeft] = useState(300); 
            const [options, setOptions] = useState([]);
            
            useEffect(() => {
                const shuffled = shuffleArray(rawVocabData);
                const listeningPart = shuffled.slice(0, 10).map(q => ({...q, type: 'listening'}));
                const readingPart = shuffled.slice(10, 20).map(q => ({...q, type: 'reading'}));
                setQuestions([...listeningPart, ...readingPart]);
            }, []);

            useEffect(() => {
                if (timeLeft > 0) {
                    const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
                    return () => clearTimeout(timer);
                } else {
                    onFinish(userAnswers, questions); 
                }
            }, [timeLeft, userAnswers]);

            useEffect(() => {
                if (questions.length > 0 && currentIndex < questions.length) {
                    const currentQ = questions[currentIndex];
                    if (currentQ.type === 'listening') setTimeout(() => playAudio(currentQ.thai), 500);
                    
                    const distractors = rawVocabData.filter(item => item.id !== currentQ.id).sort(() => 0.5 - Math.random()).slice(0, 3);
                    setOptions(shuffleArray([...distractors, currentQ]));
                }
            }, [currentIndex, questions]);

            const handleAnswer = (choiceMeaning) => {
                const currentQ = questions[currentIndex];
                const newAnswers = [...userAnswers, { question: currentQ, userChoice: choiceMeaning, isCorrect: choiceMeaning === currentQ.meaning }];
                setUserAnswers(newAnswers);
                if (currentIndex + 1 < questions.length) setCurrentIndex(currentIndex + 1);
                else onFinish(newAnswers, questions);
            };

            if (questions.length === 0) return <div className="h-full flex items-center justify-center text-white bg-gray-900">è¼‰å…¥è©¦å·ä¸­...</div>;
            const currentQ = questions[currentIndex];
            const isListening = currentQ.type === 'listening';

            return (
                <div className="flex flex-col h-full bg-gray-100 text-gray-800">
                    <div className="bg-gray-800 text-white p-4 flex justify-between items-center shadow-md">
                        <div className="font-bold text-lg">{isListening ? 'ğŸ§ è½åŠ›' : 'ğŸ“– é–±è®€'}</div>
                        <div className={`font-mono text-xl font-bold ${timeLeft < 60 ? 'animate-timer' : 'text-green-400'}`}>
                            {Math.floor(timeLeft / 60)}:{String(timeLeft % 60).padStart(2, '0')}
                        </div>
                    </div>
                    <div className="w-full bg-gray-300 h-2"><div className="bg-blue-600 h-2 transition-all duration-300" style={{ width: `${((currentIndex) / 20) * 100}%` }}></div></div>
                    <div className="flex-1 flex flex-col items-center justify-center p-6 text-center">
                        <div className="mb-8 h-32 flex flex-col items-center justify-center">
                            {isListening ? (
                                <button onClick={() => playAudio(currentQ.thai)} className="w-24 h-24 rounded-full bg-yellow-100 border-4 border-yellow-400 flex items-center justify-center text-4xl shadow-lg hover:scale-105 transition">ğŸ”Š</button>
                            ) : (
                                <h2 className="text-5xl md:text-6xl font-bold text-gray-800">{currentQ.thai}</h2>
                            )}
                        </div>
                        <div className="grid grid-cols-1 gap-3 w-full max-w-md">
                            {options.map((opt, idx) => (
                                <button key={idx} onClick={() => handleAnswer(opt.meaning)} className="p-4 bg-white border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 font-bold text-lg transition shadow-sm text-left">
                                    <span className="mr-2 text-gray-300">{String.fromCharCode(65 + idx)}.</span> {opt.meaning}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // [é é¢] æ¨¡æ“¬è€ƒ - çµæœ
        const ExamResultScreen = ({ results, onHome }) => {
            const score = results.filter(r => r.isCorrect).length;
            const percentage = Math.round((score / results.length) * 100);
            const passed = percentage >= 60; 

            return (
                <div className="h-full bg-gray-50 overflow-y-auto p-4">
                    <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
                        <div className={`p-8 text-center ${passed ? 'bg-green-600' : 'bg-red-600'} text-white`}>
                            <h2 className="text-3xl font-bold mb-1">{passed ? 'é€šé (Passed)' : 'æœªé€šé (Failed)'}</h2>
                            <div className="text-6xl font-black mt-4 mb-2">{score} <span className="text-2xl font-normal opacity-70">/ {results.length}</span></div>
                            {passed && <div className="inline-block bg-white/20 px-4 py-1 rounded-full text-sm font-bold animate-pulse">ğŸ‰ +100 XP å·²ç²å¾—ï¼</div>}
                        </div>
                        <div className="p-6">
                            <h3 className="font-bold text-gray-700 mb-4 border-b pb-2">éŒ¯é¡Œæª¢è¨</h3>
                            <div className="space-y-4">
                                {results.map((r, idx) => !r.isCorrect && (
                                    <div key={idx} className="flex items-start gap-4 p-3 bg-red-50 rounded-lg border border-red-100">
                                        <div className="bg-white p-2 rounded text-center min-w-[3rem] font-bold">{r.question.type === 'listening' ? 'ğŸ”Š' : r.question.thai}</div>
                                        <div className="text-sm">
                                            <div className="text-green-600 font-bold">æ­£è§£: {r.question.meaning} <span className="text-xs text-gray-400">({r.question.thai})</span></div>
                                            <div className="text-red-400 line-through">èª¤é¸: {r.userChoice}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="p-6 bg-gray-50 border-t text-center">
                            <button onClick={onHome} className="px-8 py-3 bg-gray-800 text-white rounded-full font-bold shadow-lg">å›é¦–é </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 3. ä¸»ç¨‹å¼è·¯ç”± ---
        function App() {
            const [view, setView] = useState('home');
            const [examResults, setExamResults] = useState(null);

            // --- XP ç³»çµ±é‚è¼¯ ---
            // å¾ localStorage è®€å– XPï¼Œé è¨­ç‚º 0
            const [xp, setXp] = useState(() => {
                const savedXp = localStorage.getItem('thai_xp');
                return savedXp ? parseInt(savedXp, 10) : 0;
            });

            // è¨ˆç®—ç­‰ç´šï¼šæ¯ 100 XP å‡ä¸€ç´š
            const level = Math.floor(xp / 100) + 1;

            // å¢åŠ  XP çš„å‡½å¼
            const addXp = (amount) => {
                const newXp = xp + amount;
                setXp(newXp);
                localStorage.setItem('thai_xp', newXp.toString());
            };
            // ------------------

            const finishExam = (results, questions) => {
                const completeResults = [...results];
                // è£œé½Šæœªå®Œæˆçš„é¡Œç›®
                if (results.length < questions.length) {
                    for (let i = results.length; i < questions.length; i++) {
                        completeResults.push({ question: questions[i], userChoice: 'é€¾æ™‚', isCorrect: false });
                    }
                }
                
                // è¨ˆç®—æˆç¸¾èˆ‡ç™¼æ”¾çå‹µ
                const score = completeResults.filter(r => r.isCorrect).length;
                const percentage = Math.round((score / questions.length) * 100);
                if (percentage >= 60) {
                    addXp(100); // åŠæ ¼çå‹µ
                }

                setExamResults(completeResults);
                setView('examResult');
            };

            return (
                <div className="h-full w-full max-w-md mx-auto bg-white shadow-2xl overflow-hidden">
                    {view === 'home' && <HomeScreen onStart={setView} xp={xp} level={level} />}
                    {view === 'alphabet' && <AlphabetScreen onBack={() => setView('home')} />}
                    {view === 'rules' && <RulesScreen onBack={() => setView('home')} />}
                    {view === 'learn' && <LearnScreen onBack={() => setView('home')} />}
                    {view === 'quiz' && <PracticeQuizScreen onBack={() => setView('home')} addXp={addXp} />}
                    {view === 'examIntro' && <ExamIntroScreen onStart={() => setView('exam')} onBack={() => setView('home')} />}
                    {view === 'exam' && <ExamScreen onFinish={finishExam} />}
                    {view === 'examResult' && <ExamResultScreen results={examResults} onHome={() => setView('home')} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>