<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPTFL æ³°èªå…¨èƒ½ç‰¹è¨“ v10 (æ–°å¢æƒ…å¢ƒé¡Œç‰ˆ)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="./vocab-data.js?v=2"></script>

    <link rel="stylesheet" href="./style.css">
</head>
<body class="bg-yellow-50 text-gray-800 h-screen overflow-hidden font-sans select-none">

    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

// --- 0. å…¨åŸŸå·¥å…·å‡½å¼ ---
window.shuffleArray = (array) => {
    if (!array || !Array.isArray(array)) {
        console.error("Shuffle Error: è¼¸å…¥ä¸æ˜¯é™£åˆ—", array);
        return [];
    }
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
};

window.playAudio = (text) => {
    try {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.8;
        const voices = window.speechSynthesis.getVoices();
        const thaiVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('th')) 
                       || voices.find(v => v.lang.includes('th-TH'))
                       || voices.find(v => v.lang.includes('th'));
        if (thaiVoice) utterance.voice = thaiVoice;
        utterance.lang = thaiVoice ? thaiVoice.lang : 'th-TH';
        window.speechSynthesis.speak(utterance);
    } catch (e) {
        console.error("èªéŸ³æ’­æ”¾å¤±æ•—:", e);
    }
};

// åœ¨ app.js å¤§ç´„ç¬¬ 35 è¡Œå·¦å³
window.getDB = () => {
    const db = window.taiData;
    if (!db) {
        console.error("âŒ åš´é‡éŒ¯èª¤: window.taiData æ‰¾ä¸åˆ°ï¼è«‹ç¢ºèª vocab-data.js æ˜¯å¦æœ‰è¼‰å…¥æˆåŠŸã€‚");
        // é€™è£¡ä¹Ÿè¦è£œä¸Š situationData: [] ä»¥é˜²è¬ä¸€
        return { rawVocabData: [], consonantData: [], vowelData: [], situationData: [] };
    }
    return {
        rawVocabData: db.rawVocabData || [],
        consonantData: db.consonantData || [],
        vowelData: db.vowelData || [],
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ é€™è£¡å¿…é ˆåŠ ä¸Šé€™è¡Œï¼Œå…ƒä»¶æ‰æ‹¿å¾—åˆ°è³‡æ–™ï¼ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        situationData: db.situationData || [] 
    };
};

// --- 1. å…ƒä»¶å€ ---

const HomeScreen = ({ onStart, xp, level }) => {
    const progress = xp % 100;
    return (
        <div className="flex flex-col items-center h-full p-4 animate-fade-in bg-yellow-50 overflow-y-auto">
            <div className="text-center mt-6 mb-4">
                <h1 className="text-3xl md:text-5xl font-extrabold text-yellow-600 mb-2">ğŸ‡¹ğŸ‡­ CPTFL ç‰¹è¨“</h1>
                <p className="text-gray-500 text-sm">v9.5 (100 Situations)</p>
            </div>
            <div className="w-full max-w-md bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-4 text-white shadow-lg mb-6 relative overflow-hidden">
                <div className="relative z-10 flex justify-between items-end mb-2">
                    <div><div className="text-indigo-200 text-xs font-bold uppercase">Level</div><div className="text-4xl font-black">Lv.{level}</div></div>
                    <div className="text-right"><div className="text-indigo-200 text-xs font-bold uppercase">Total XP</div><div className="text-2xl font-bold">{xp}</div></div>
                </div>
                <div className="relative w-full h-3 bg-black/30 rounded-full overflow-hidden"><div className="absolute top-0 left-0 h-full bg-yellow-400 transition-all duration-500" style={{ width: `${progress}%` }}></div></div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-md pb-8">
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <h3 className="text-gray-400 text-xs uppercase tracking-wider mb-2 font-bold">åŸºç¤å­¸ç¿’</h3>
                    <div className="grid grid-cols-2 gap-2">
                        <button onClick={() => onStart('learn')} className="p-3 bg-blue-50 text-blue-700 rounded-lg font-bold hover:bg-blue-100 transition">å–®å­—å¡</button>
                        <button onClick={() => onStart('vocabList')} className="p-3 bg-orange-50 text-orange-700 rounded-lg font-bold hover:bg-orange-100 transition">å–®å­—ç¸½è¡¨</button> {/* æ–°å¢é€™è¡Œ */}
                        <button onClick={() => onStart('rules')} className="p-3 bg-purple-50 text-purple-700 rounded-lg font-bold hover:bg-purple-100 transition">è²èª¿è¡¨</button>
                        <button onClick={() => onStart('alphabet')} className="p-3 bg-pink-50 text-pink-700 rounded-lg font-bold hover:bg-pink-100 transition">å­—æ¯ç™¼éŸ³</button>
                    </div>
                </div>
                <div className="bg-white p-4 rounded-2xl shadow-lg border-2 border-yellow-400 relative overflow-hidden">
                    <h3 className="text-yellow-600 text-xs uppercase tracking-wider mb-2 font-bold">æ¸¬é©—æ¨¡å¼</h3>
                    <div className="space-y-2">
                        <button onClick={() => onStart('situation')} className="w-full p-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-500 transition shadow-md flex justify-between items-center group">
                        <span>ğŸ§ æƒ…å¢ƒè½åŠ›æŒ‘æˆ°</span> <span className="text-xs bg-white/20 px-2 py-0.5 rounded group-hover:bg-white/30 font-mono">NEW!</span>
                    </button>
                        <button onClick={() => onStart('quiz')} className="w-full p-3 bg-green-50 text-green-700 rounded-lg font-bold hover:bg-green-100 transition flex justify-between items-center"><span>éš¨æ©Ÿç·´ç¿’</span> <span className="text-xs bg-green-200 px-2 py-0.5 rounded text-green-800 font-mono">+10 XP</span></button>
                        <button onClick={() => onStart('examIntro')} className="w-full p-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition shadow-md flex justify-between items-center group"><span>ğŸ† å¯¦æˆ°æ¨¡æ“¬è€ƒ</span> <span className="text-xs bg-white/20 px-2 py-0.5 rounded group-hover:bg-white/30 font-mono">+100 XP</span></button>
                        <button onClick={() => onStart('history')} className="w-full p-3 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200 transition flex justify-between items-center"><span>ğŸ“œ æ­·å²ç´€éŒ„</span> <span className="text-xs text-gray-400">æŸ¥çœ‹æˆç¸¾</span></button>
                    </div>
                </div>
            </div>
        </div>
    );
};

// ğŸ”´ é‡é»ä¿®æ­£ï¼šLearnScreen
const LearnScreen = ({ onBack }) => {
    // 1. æ‰€æœ‰çš„ Hooks å¿…é ˆæ”¾åœ¨æœ€ä¸Šé¢
    const [mode, setMode] = useState('menu');
    const [cards, setCards] = useState([]);
    const [categories, setCategories] = useState([]);
    const [selectedCategoryName, setSelectedCategoryName] = useState('');
    const [currentIndex, setCurrentIndex] = useState(0);
    const [isFlipped, setIsFlipped] = useState(false);
    const [showPinyin, setShowPinyin] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');

    // 2. é€™å…©å€‹ useEffect å¿…é ˆåœ¨ä»»ä½• if/return ä¹‹å‰åŸ·è¡Œ
    useEffect(() => {
        const { rawVocabData } = window.getDB();
        if (rawVocabData.length > 0) {
            const cats = [...new Set(rawVocabData.map(d => d.category).filter(Boolean))];
            setCategories(cats);
        }
    }, []);

    // âš ï¸ ä¿®æ­£é»ï¼šåŸæœ¬é€™å€‹ Hook è¢«æ”¾åœ¨äº† return ä¸‹é¢ï¼Œç¾åœ¨ç§»åˆ°é€™è£¡äº†
    useEffect(() => { 
        setCurrentIndex(0); 
        setIsFlipped(false); 
    }, [searchTerm]);

    // --- é‚è¼¯å€ ---
    const startRandom = () => {
        const { rawVocabData } = window.getDB();
        if (rawVocabData.length === 0) { alert("è³‡æ–™åº«æ˜¯ç©ºçš„ï¼"); return; }
        setCards(window.shuffleArray(rawVocabData));
        setSelectedCategoryName('éš¨æ©Ÿå…¨éƒ¨');
        setMode('card');
        setCurrentIndex(0);
        setSearchTerm('');
    };

    const startCategory = (cat) => {
        const { rawVocabData } = window.getDB();
        const filtered = rawVocabData.filter(d => d.category === cat);
        setCards(window.shuffleArray(filtered));
        setSelectedCategoryName(cat);
        setMode('card');
        setCurrentIndex(0);
        setSearchTerm('');
    };

    const handleBack = () => {
        if (mode === 'card' || mode === 'category') setMode('menu');
        else onBack();
    };

    // --- æ¸²æŸ“å€ (ç¾åœ¨é€™è£¡å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ return) ---

    if (mode === 'menu') {
        return (
            <div className="h-full flex flex-col p-6 bg-blue-50 max-w-md mx-auto">
                <button onClick={onBack} className="self-start text-gray-500 mb-6 hover:bg-blue-100 px-3 py-1 rounded">â¬…ï¸ å›é¦–é </button>
                <h2 className="text-3xl font-bold text-blue-800 mb-8 text-center">å–®å­—å¡æ¨¡å¼</h2>
                <div className="space-y-4">
                    <button onClick={startRandom} className="w-full p-6 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl shadow-lg hover:from-blue-600 hover:to-blue-700 transition transform hover:scale-[1.02] flex items-center justify-between group">
                        <div className="text-left"><div className="text-xl font-bold">ğŸ”€ éš¨æ©Ÿå…¨éƒ¨</div><div className="text-sm text-blue-100 opacity-80">æ··å’Œæ‰€æœ‰å–®å­—</div></div>
                        <span className="text-3xl group-hover:rotate-12 transition">ğŸ²</span>
                    </button>
                    <button onClick={() => setMode('category')} className="w-full p-6 bg-white border-2 border-blue-200 text-blue-700 rounded-2xl shadow-sm hover:border-blue-400 hover:bg-blue-50 transition transform hover:scale-[1.02] flex items-center justify-between group">
                        <div className="text-left"><div className="text-xl font-bold">ğŸ“‚ é¸æ“‡åˆ†é¡</div><div className="text-sm text-gray-500">é‡å°ç‰¹å®šä¸»é¡Œ</div></div>
                        <span className="text-3xl group-hover:translate-x-1 transition">ğŸ‘‰</span>
                    </button>
                </div>
            </div>
        );
    }

    if (mode === 'category') {
        return (
            <div className="h-full flex flex-col p-4 bg-white max-w-md mx-auto">
                <div className="flex items-center mb-6">
                    <button onClick={() => setMode('menu')} className="text-gray-500 hover:bg-gray-100 px-3 py-1 rounded mr-4">â¬…ï¸ è¿”å›</button>
                    <h2 className="text-xl font-bold text-gray-800">é¸æ“‡ä¸»é¡Œ</h2>
                </div>
                <div className="grid grid-cols-2 gap-3 overflow-y-auto pb-4 content-start">
                    {categories.length === 0 ? <p className="col-span-2 text-center text-red-500">æ²’æœ‰æ‰¾åˆ°åˆ†é¡</p> : categories.map((cat, idx) => (
                        <button key={idx} onClick={() => startCategory(cat)} className="p-4 rounded-xl bg-gray-50 border border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition text-center flex flex-col items-center justify-center h-24 shadow-sm">
                            <span className="font-bold text-lg text-gray-700">{cat}</span>
                        </button>
                    ))}
                </div>
            </div>
        );
    }

    // è¨ˆç®—éæ¿¾å¾Œçš„å¡ç‰‡
    const filteredCards = cards.filter(card => {
        const keyword = searchTerm.trim().toLowerCase();
        if (!keyword) return true;
        return (card.thai && card.thai.toLowerCase().includes(keyword)) || (card.pinyin && card.pinyin.toLowerCase().includes(keyword)) || (card.meaning && card.meaning.toLowerCase().includes(keyword));
    });

    const safeIndex = filteredCards.length === 0 ? 0 : currentIndex % filteredCards.length;
    const card = filteredCards[safeIndex];

    const changeCard = (dir) => {
        setIsFlipped(false);
        setTimeout(() => setCurrentIndex((prev) => (filteredCards.length === 0 ? 0 : (prev + dir + filteredCards.length) % filteredCards.length)), 200);
    };

    return (
        <div className="flex flex-col h-full max-w-md mx-auto p-4 bg-white">
            <div className="mb-2">
                <div className="flex justify-between items-center mb-2">
                     <button onClick={handleBack} className="text-gray-500 hover:bg-gray-100 px-3 py-1 rounded">â¬…ï¸ é¸å–®</button>
                     <span className="text-sm font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">{selectedCategoryName}</span>
                </div>
                <div className="relative">
                    <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full py-2 pl-4 pr-4 rounded-full border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder={`åœ¨ã€Œ${selectedCategoryName}ã€ä¸­æœå°‹...`} />
                </div>
            </div>
            <div className="flex justify-end mb-2"><span className="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold">{filteredCards.length === 0 ? 0 : safeIndex + 1} / {filteredCards.length}</span></div>
            <div className="flex-1 flex flex-col justify-center perspective-1000 my-2">
                {filteredCards.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-80 text-gray-400 font-bold bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200"><p>æ‰¾ä¸åˆ°å–®å­—</p></div>
                ) : (
                    <div onClick={() => setIsFlipped(!isFlipped)} className={`relative w-full h-80 bg-gray-50 border-2 border-gray-100 rounded-3xl shadow-xl cursor-pointer transition-all duration-500 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                        <div className={`absolute inset-0 flex flex-col items-center justify-center backface-hidden p-6 ${isFlipped ? 'hidden' : 'flex'}`}>
                            <span className="text-sm text-gray-400 uppercase tracking-wider mb-2">{card.category}</span>
                            <h2 className="text-5xl font-bold text-gray-800 mb-4 text-center leading-tight">{card.thai}</h2>
                            {showPinyin ? <p className="text-xl text-blue-500 font-medium">{card.pinyin}</p> : <div className="h-7 w-32 bg-gray-200 rounded animate-pulse"></div>}
                            <button onClick={e => { e.stopPropagation(); window.playAudio(card.thai); }} className="mt-6 p-3 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-700 transition">ğŸ”Š</button>
                        </div>
                        <div className={`absolute inset-0 flex flex-col items-center justify-center backface-hidden p-6 bg-blue-50 rounded-3xl ${isFlipped ? 'flex' : 'hidden'}`} style={{ transform: 'rotateY(180deg)' }}>
                            <h3 className="text-3xl font-bold text-gray-800 mb-2">{card.meaning}</h3>
                        </div>
                    </div>
                )}
            </div>
            <div className="space-y-4">
                <div className="flex justify-center gap-4">
                    <button onClick={() => changeCard(-1)} className="px-6 py-3 bg-gray-200 rounded-xl font-bold text-gray-600 disabled:opacity-50" disabled={filteredCards.length === 0}>ä¸Šä¸€å€‹</button>
                    <button onClick={() => changeCard(1)} className="px-6 py-3 bg-blue-500 rounded-xl font-bold text-white shadow-lg disabled:opacity-50" disabled={filteredCards.length === 0}>ä¸‹ä¸€å€‹</button>
                </div>
                <button onClick={() => setShowPinyin(!showPinyin)} className="w-full text-center text-sm text-gray-500 py-2" disabled={filteredCards.length === 0}>{showPinyin ? 'ğŸ‘ï¸ éš±è—æ‹¼éŸ³' : 'ğŸ‘ï¸â€ğŸ—¨ï¸ é¡¯ç¤ºæ‹¼éŸ³'}</button>
            </div>
        </div>
    );
};

// [æ–°å¢å…ƒä»¶] å–®å­—ç¸½è¡¨ (åˆ†é¡ + æœå°‹)
const VocabListScreen = ({ onBack }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [groupedData, setGroupedData] = useState({});
    
    // å–å¾—è³‡æ–™
    const { rawVocabData } = window.getDB();

    // è™•ç†è³‡æ–™åˆ†é¡èˆ‡éæ¿¾
    useEffect(() => {
        const term = searchTerm.trim().toLowerCase();
        
        // 1. å…ˆæ‰¾å‡ºæ‰€æœ‰ä¸é‡è¤‡çš„åˆ†é¡
        const categories = [...new Set(rawVocabData.map(d => d.category).filter(Boolean))];
        
        // 2. å»ºç«‹åˆ†é¡ç‰©ä»¶
        const groups = {};
        
        categories.forEach(cat => {
            // 3. éæ¿¾ç¬¦åˆæœå°‹æ¢ä»¶çš„å–®å­—
            const words = rawVocabData.filter(d => 
                d.category === cat && (
                    d.thai.toLowerCase().includes(term) || 
                    d.pinyin.toLowerCase().includes(term) || 
                    d.meaning.toLowerCase().includes(term)
                )
            );
            
            // åªæœ‰ç•¶è©²åˆ†é¡ä¸‹æœ‰å–®å­—æ™‚æ‰åŠ å…¥
            if (words.length > 0) {
                groups[cat] = words;
            }
        });
        
        setGroupedData(groups);
    }, [searchTerm, rawVocabData]);

    return (
        <div className="flex flex-col h-full bg-gray-50 max-w-md mx-auto">
            {/* é ‚éƒ¨æœå°‹å€ */}
            <div className="bg-white p-4 shadow-sm z-10">
                <div className="flex items-center mb-3">
                    <button onClick={onBack} className="text-gray-500 hover:bg-gray-100 px-3 py-1 rounded mr-2">â¬…ï¸ è¿”å›</button>
                    <h2 className="text-xl font-bold text-gray-800">å–®å­—ç¸½è¡¨</h2>
                </div>
                <div className="relative">
                    <span className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">ğŸ”</span>
                    <input 
                        type="text" 
                        value={searchTerm} 
                        onChange={(e) => setSearchTerm(e.target.value)} 
                        className="w-full py-2 pl-10 pr-4 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-200 transition" 
                        placeholder="æœå°‹æ³°æ–‡ã€æ‹¼éŸ³æˆ–ä¸­æ–‡..." 
                    />
                </div>
            </div>

            {/* åˆ—è¡¨å…§å®¹å€ */}
            <div className="flex-1 overflow-y-auto p-4 space-y-6">
                {Object.keys(groupedData).length === 0 ? (
                    <div className="text-center text-gray-400 mt-10">æ‰¾ä¸åˆ°ç¬¦åˆçš„å–®å­—</div>
                ) : (
                    Object.keys(groupedData).map((cat) => (
                        <div key={cat} className="animate-fade-in">
                            <h3 className="text-blue-600 font-bold text-sm bg-blue-50 inline-block px-3 py-1 rounded-full mb-3 shadow-sm border border-blue-100">
                                ğŸ“‚ {cat} <span className="text-blue-400 ml-1 text-xs">({groupedData[cat].length})</span>
                            </h3>
                            <div className="grid grid-cols-1 gap-3">
                                {groupedData[cat].map((word) => (
                                    <div key={word.id} className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center hover:shadow-md transition group">
                                        <div>
                                            <div className="font-bold text-lg text-gray-800">{word.thai}</div>
                                            <div className="text-xs text-blue-500 font-mono mb-0.5">{word.pinyin}</div>
                                            <div className="text-sm text-gray-600">{word.meaning}</div>
                                        </div>
                                        <button 
                                            onClick={() => window.playAudio(word.thai)} 
                                            className="w-10 h-10 rounded-full bg-gray-50 text-gray-400 flex items-center justify-center hover:bg-blue-100 hover:text-blue-600 transition active:scale-95"
                                        >
                                            ğŸ”Š
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>
    );
};

const HistoryScreen = ({ onBack, onViewRecord }) => {
    const [history, setHistory] = useState([]);
    useEffect(() => {
        const saved = localStorage.getItem('thai_exam_history');
        if (saved) { try { setHistory(JSON.parse(saved).reverse()); } catch (e) { console.error(e); } }
    }, []);
    return (
        <div className="h-full flex flex-col bg-gray-50 max-w-md mx-auto">
            <div className="p-4 bg-white shadow-sm flex justify-between items-center">
                <button onClick={onBack} className="text-gray-500 hover:bg-gray-100 px-3 py-1 rounded">â¬…ï¸ é¦–é </button>
                <h2 className="font-bold text-gray-800">è€ƒè©¦ç´€éŒ„ ({history.length})</h2>
                <button onClick={() => { if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) { localStorage.removeItem('thai_exam_history'); setHistory([]); }}} className="text-xs text-red-400 hover:text-red-600">æ¸…ç©º</button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                {history.length === 0 ? <div className="text-center text-gray-400 mt-10">å°šç„¡ç´€éŒ„</div> : history.map((r) => (
                    <div key={r.id} onClick={() => onViewRecord(r)} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:border-blue-300 transition cursor-pointer flex justify-between items-center">
                        <div><div className="text-xs text-gray-400 mb-1">{new Date(r.date).toLocaleString()}</div><div className="font-bold text-gray-800 flex items-center gap-2">{r.score >= (r.totalQuestions * 0.6) ? <span className="text-green-600 bg-green-50 px-2 py-0.5 rounded text-xs">PASS</span> : <span className="text-red-500 bg-red-50 px-2 py-0.5 rounded text-xs">FAIL</span>}<span className="text-lg">{r.score}</span><span className="text-sm text-gray-400">/ {r.totalQuestions}é¡Œ</span></div></div>
                        <div className="text-gray-400">ğŸ‘‰</div>
                    </div>
                ))}
            </div>
        </div>
    );
};

const PracticeQuizScreen = ({ onBack, addXp }) => {
    const [qIndex, setQIndex] = useState(0);
    const { rawVocabData } = window.getDB();
    const [questions] = useState(() => window.shuffleArray(rawVocabData));
    const [options, setOptions] = useState([]);
    const [selected, setSelected] = useState(null);
    const [showXpAnim, setShowXpAnim] = useState(false);
    
    useEffect(() => {
        if (qIndex < questions.length) {
            const correct = questions[qIndex];
            const others = rawVocabData.filter(d => d.id !== correct.id).sort(()=>0.5-Math.random()).slice(0,3);
            setOptions(window.shuffleArray([...others, correct]));
        }
    }, [qIndex]);

    const handleAns = (meaning) => {
        window.playAudio(questions[qIndex].thai);
        setSelected(meaning);
        if (meaning === questions[qIndex].meaning) {
            addXp(10);
            setShowXpAnim(true);
            setTimeout(() => setShowXpAnim(false), 1000);
        }
        setTimeout(() => { if(qIndex < questions.length-1) { setQIndex(qIndex+1); setSelected(null); } else { alert("ç·´ç¿’çµæŸï¼"); onBack(); } }, 1500);
    };
    if (qIndex >= questions.length) return null;
    return (
        <div className="flex flex-col h-full p-4 bg-green-50 max-w-md mx-auto relative overflow-hidden">
           {showXpAnim && <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 text-yellow-500 font-black text-4xl animate-float-up pointer-events-none drop-shadow-md">+10 XP</div>}
           <button onClick={onBack} className="self-start text-gray-500 mb-4 hover:bg-green-100 px-3 py-1 rounded">â¬…ï¸ é€€å‡º</button>
           <div className="w-full bg-gray-200 h-2 rounded-full mb-4"><div className="bg-green-500 h-2 rounded-full transition-all" style={{width: `${(qIndex/questions.length)*100}%`}}></div></div>
           <div className="flex-1 flex flex-col justify-center text-center">
                <h2 className="text-6xl font-bold text-green-800 mb-8">{questions[qIndex].thai}</h2>
                <div className="grid gap-3">{options.map((opt, i) => (<button key={i} onClick={() => handleAns(opt.meaning)} disabled={selected!==null} className={`p-4 rounded-xl border-2 text-lg font-bold transition ${selected === null ? 'bg-white border-green-100 hover:border-green-400' : opt.meaning === questions[qIndex].meaning ? 'bg-green-500 text-white border-green-600' : opt.meaning === selected ? 'bg-red-500 text-white border-red-600' : 'bg-white opacity-30'}`}>{opt.meaning}</button>))}</div>
           </div>
        </div>
    );
};

// [æ–°å¢å…ƒä»¶] æƒ…å¢ƒæŒ‘æˆ°è¨­å®šé  (é¸æ“‡é¡Œæ•¸)
const SituationIntroScreen = ({ onStart, onBack }) => {
    const { situationData } = window.getDB();
    const maxLimit = situationData.length;
    // é è¨­ 10 é¡Œï¼Œå¦‚æœè³‡æ–™åº«å°‘æ–¼ 10 é¡Œå°±å…¨é¸
    const [qCount, setQCount] = useState(Math.min(10, maxLimit));

    return (
        <div className="flex flex-col items-center justify-center h-full p-6 bg-gray-900 text-white overflow-y-auto">
            <div className="max-w-md w-full text-center space-y-6 animate-fade-in my-auto">
                <div className="mb-4">
                    <span className="text-6xl animate-bounce-slow">ğŸ§</span>
                </div>
                <h2 className="text-3xl font-bold text-purple-400">æƒ…å¢ƒè½åŠ›æŒ‘æˆ°</h2>
                <p className="text-gray-400 text-sm">è«‹è†è½æ³°èªå°è©±ï¼Œä¸¦é¸æ“‡æ­£ç¢ºçš„å›ç­”ã€‚</p>
                
                <div className="text-left bg-gray-800 p-6 rounded-xl space-y-4 border border-gray-700">
                    <label className="block text-gray-400 font-bold flex justify-between">
                        <span>æŒ‘æˆ°é¡Œæ•¸</span>
                        <span className="text-yellow-400 text-xl">{qCount} é¡Œ</span>
                    </label>
                    <input 
                        type="range" 
                        min="5" 
                        max={maxLimit} 
                        step="5"
                        value={qCount} 
                        onChange={(e) => setQCount(parseInt(e.target.value))} 
                        className="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-purple-500" 
                    />
                    <div className="flex justify-between text-xs text-gray-500 font-mono">
                        <span>5</span>
                        <span>{Math.floor(maxLimit/2)}</span>
                        <span>{maxLimit}</span>
                    </div>
                    <p className="text-xs text-gray-500 pt-2 flex items-center gap-1">
                        â±ï¸ é è¨ˆè€—æ™‚: {Math.ceil(qCount * 0.5)} åˆ†é˜
                    </p>
                </div>

                <div className="pt-4 flex gap-4 justify-center">
                    <button onClick={onBack} className="px-6 py-3 rounded-full border border-gray-600 hover:bg-gray-800 transition">å–æ¶ˆ</button>
                    <button onClick={() => onStart(qCount)} className="px-8 py-3 rounded-full bg-purple-600 font-bold hover:bg-purple-500 shadow-lg hover:scale-105 transition animate-pulse">
                        é–‹å§‹æŒ‘æˆ°
                    </button>
                </div>
            </div>
        </div>
    );
};

// [ä¿®æ”¹å…ƒä»¶] æƒ…å¢ƒè½åŠ›æŒ‘æˆ° (æ¥æ”¶ limit åƒæ•¸)
const SituationScreen = ({ onBack, addXp, limit }) => {
    const { situationData } = window.getDB();
    const [qIndex, setQIndex] = useState(0);
    
    // åˆå§‹åŒ–é¡Œç›®ï¼šæ´—ç‰Œå¾Œåˆ‡å‡ºæŒ‡å®šæ•¸é‡
    const [questions] = useState(() => {
        const shuffled = window.shuffleArray(situationData || []);
        const safeLimit = limit || 10; // å¦‚æœæ²’å‚³ limitï¼Œé è¨­ 10
        return shuffled.slice(0, safeLimit);
    });

    const [hasAnswered, setHasAnswered] = useState(false);
    const [selectedOptionIndex, setSelectedOptionIndex] = useState(null);
    const [showExplanation, setShowExplanation] = useState(false);

    // æ’­æ”¾éŸ³æ•ˆ (é¡Œç›®åˆ‡æ›æ™‚)
    useEffect(() => {
        if (questions.length > 0 && !hasAnswered) {
            const timer = setTimeout(() => window.playAudio(questions[qIndex].audioText), 800);
            return () => clearTimeout(timer);
        }
    }, [qIndex, questions, hasAnswered]);

    const handleOptionClick = (idx, isCorrect) => {
        if (hasAnswered) return;
        
        setSelectedOptionIndex(idx);
        setHasAnswered(true);
        setShowExplanation(true);

        if (isCorrect) {
            // ç­”å°æ’­æ”¾ä¸€å€‹ç°¡å–®çš„æç¤ºéŸ³ (é€™è£¡ç”¨ç³»çµ±èªéŸ³æ¨¡æ“¬ "Ping" æˆ–ç›´æ¥ä¸æ’­)
            // window.playAudio("Correct"); 
            addXp(15); 
        } else {
            // ç­”éŒ¯é‚è¼¯
        }
    };

    const nextQuestion = () => {
        if (qIndex < questions.length - 1) {
            setQIndex(prev => prev + 1);
            setHasAnswered(false);
            setSelectedOptionIndex(null);
            setShowExplanation(false);
        } else {
            alert(`æŒ‘æˆ°å®Œæˆï¼æ­å–œä½ å®Œæˆäº† ${questions.length} é¡Œç·´ç¿’ã€‚`);
            onBack();
        }
    };

    if (!situationData || situationData.length === 0) return <div className="p-10 text-center text-white">è®€å–è³‡æ–™ä¸­...æˆ–è«‹æª¢æŸ¥ vocab-data.js</div>;
    if (questions.length === 0) return <div className="p-10 text-center">æ²’æœ‰é¡Œç›®</div>;
    
    const currentQ = questions[qIndex];

    return (
        <div className="flex flex-col h-full bg-gradient-to-b from-purple-50 to-white max-w-md mx-auto">
            {/* é ‚éƒ¨å°èˆª */}
            <div className="p-4 flex justify-between items-center shadow-sm bg-white">
                <button onClick={onBack} className="text-gray-500 hover:bg-gray-100 px-3 py-1 rounded">â¬…ï¸ é€€å‡º</button>
                <div className="text-purple-600 font-bold">æƒ…å¢ƒæŒ‘æˆ° {qIndex + 1} / {questions.length}</div>
            </div>

            {/* é€²åº¦æ¢ */}
            <div className="w-full bg-gray-200 h-1.5"><div className="bg-purple-500 h-1.5 transition-all duration-300" style={{width: `${((qIndex+1)/questions.length)*100}%`}}></div></div>

            {/* ä¸»è¦å…§å®¹å€ */}
            <div className="flex-1 overflow-y-auto p-4 flex flex-col items-center">
                
                {/* æƒ…å¢ƒæè¿°å¡ */}
                <div className="w-full bg-white rounded-2xl p-6 shadow-lg border border-purple-100 mb-6 text-center relative overflow-hidden">
                    <div className="absolute top-0 left-0 bg-purple-600 text-white text-xs px-3 py-1 rounded-br-xl font-bold">{currentQ.category}</div>
                    
                    <div className="mt-4 mb-2 text-gray-500 text-xs uppercase tracking-wider">Listen carefully</div>
                    
                    {/* æ’­æ”¾æŒ‰éˆ• */}
                    <button 
                        onClick={() => window.playAudio(currentQ.audioText)}
                        className="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center text-4xl shadow-md hover:scale-105 hover:bg-purple-200 transition active:scale-95 mx-auto mb-4 text-purple-600 border-4 border-white ring-2 ring-purple-100"
                    >
                        ğŸ”Š
                    </button>
                    
                    <div className="text-gray-800 font-bold text-lg mb-2 leading-snug">{currentQ.context}</div>
                    <div className="text-purple-800 font-bold text-xl">{currentQ.question}</div>
                </div>

                {/* é¸é …å€ */}
                <div className="w-full space-y-3 pb-4">
                    {currentQ.options.map((opt, idx) => {
                        let btnClass = "w-full p-4 rounded-xl border-2 text-left font-bold transition flex justify-between items-center shadow-sm ";
                        
                        if (!hasAnswered) {
                            btnClass += "bg-white border-gray-100 hover:border-purple-400 hover:bg-purple-50 text-gray-700 hover:translate-x-1";
                        } else {
                            if (opt.isCorrect) btnClass += "bg-green-100 border-green-500 text-green-800"; // æ­£ç¢ºç­”æ¡ˆé¡¯ç¤ºç¶ è‰²
                            else if (idx === selectedOptionIndex) btnClass += "bg-red-100 border-red-500 text-red-800"; // é¸éŒ¯é¡¯ç¤ºç´…è‰²
                            else btnClass += "bg-gray-50 border-gray-100 text-gray-400 opacity-50"; // å…¶ä»–é¸é …è®Šæ·¡
                        }

                        return (
                            <button key={idx} onClick={() => handleOptionClick(idx, opt.isCorrect)} disabled={hasAnswered} className={btnClass}>
                                <div className="flex items-center">
                                    <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs mr-3 ${hasAnswered && opt.isCorrect ? 'bg-green-200 text-green-800' : 'bg-gray-100 text-gray-500'}`}>{["A", "B", "C"][idx]}</span>
                                    <span>{opt.text}</span>
                                </div>
                                {hasAnswered && opt.isCorrect && <span>âœ…</span>}
                                {hasAnswered && !opt.isCorrect && idx === selectedOptionIndex && <span>âŒ</span>}
                            </button>
                        );
                    })}
                </div>

                {/* è§£æå€ (ç­”é¡Œå¾Œé¡¯ç¤º) */}
                {showExplanation && (
                    <div className="w-full bg-blue-50 p-5 rounded-2xl border border-blue-200 animate-fade-in shadow-inner mb-4">
                        <div className="font-bold text-blue-800 mb-2 flex items-center gap-2">ğŸ’¡ è§£æ <span className="text-xs font-normal text-blue-600 bg-blue-100 px-2 rounded-full">Explanation</span></div>
                        <p className="text-blue-900 text-sm leading-relaxed">{currentQ.explanation}</p>
                        <button onClick={nextQuestion} className="mt-4 w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-500 transition transform active:scale-95">
                            {qIndex < questions.length - 1 ? 'ä¸‹ä¸€é¡Œ âœ' : 'å®ŒæˆæŒ‘æˆ° ğŸ'}
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
};

const ExamIntroScreen = ({ onStart, onBack }) => {
    const { rawVocabData } = window.getDB();
    const maxLimit = Math.min(100, rawVocabData.length);
    const [qCount, setQCount] = useState(Math.min(20, rawVocabData.length));
    return (
        <div className="flex flex-col items-center justify-center h-full p-6 bg-gray-900 text-white overflow-y-auto">
            <div className="max-w-md w-full text-center space-y-6 animate-fade-in my-auto">
                <h2 className="text-3xl font-bold text-red-400">æ¨¡æ“¬è€ƒè¨­å®š</h2>
                <div className="text-left bg-gray-800 p-6 rounded-xl space-y-4 border border-gray-700">
                    <label className="block text-gray-400 font-bold flex justify-between"><span>é¡Œæ•¸</span><span className="text-yellow-400">{qCount} é¡Œ</span></label>
                    <input type="range" min="5" max={maxLimit} value={qCount} onChange={(e) => setQCount(parseInt(e.target.value))} className="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-red-500" />
                    <p className="flex items-center gap-2">â±ï¸ {Math.ceil(qCount * 15 / 60)} åˆ†é˜</p>
                </div>
                <div className="pt-2 flex gap-4 justify-center"><button onClick={onBack} className="px-6 py-3 rounded-full border border-gray-600">å–æ¶ˆ</button><button onClick={() => onStart(qCount)} className="px-8 py-3 rounded-full bg-red-600 font-bold hover:bg-red-500 shadow-lg animate-pulse">é–‹å§‹è€ƒè©¦</button></div>
            </div>
        </div>
    );
};

const ExamScreen = ({ questionCount, onFinish }) => {
    const [questions, setQuestions] = useState([]);
    const [currentIndex, setCurrentIndex] = useState(0);
    const [userAnswers, setUserAnswers] = useState([]); 
    const [timeLeft, setTimeLeft] = useState(0); 
    const [options, setOptions] = useState([]);
    const { rawVocabData } = window.getDB();

    useEffect(() => {
        if(rawVocabData.length === 0) return;
        setTimeLeft(questionCount * 15);
        const shuffled = window.shuffleArray(rawVocabData).slice(0, questionCount);
        const splitIndex = Math.floor(questionCount / 2);
        setQuestions([...shuffled.slice(0, splitIndex).map(q => ({...q, type: 'listening'})), ...shuffled.slice(splitIndex).map(q => ({...q, type: 'reading'}))]);
    }, [questionCount]);

    useEffect(() => {
        if (questions.length > 0 && timeLeft > 0) { const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000); return () => clearTimeout(timer); } 
        else if (questions.length > 0 && timeLeft === 0) onFinish(userAnswers, questions); 
    }, [timeLeft, questions, userAnswers]);

    useEffect(() => {
        if (questions.length > 0 && currentIndex < questions.length) {
            const currentQ = questions[currentIndex];
            if (currentQ.type === 'listening') setTimeout(() => window.playAudio(currentQ.thai), 500);
            const distractors = rawVocabData.filter(item => item.id !== currentQ.id).sort(() => 0.5 - Math.random()).slice(0, 3);
            setOptions(window.shuffleArray([...distractors, currentQ]));
        }
    }, [currentIndex, questions]);

    const handleAnswer = (choiceMeaning) => {
        const currentQ = questions[currentIndex];
        const newAnswers = [...userAnswers, { question: currentQ, userChoice: choiceMeaning, isCorrect: choiceMeaning === currentQ.meaning }];
        setUserAnswers(newAnswers);
        if (currentIndex + 1 < questions.length) setCurrentIndex(currentIndex + 1); else onFinish(newAnswers, questions);
    };

    if (questions.length === 0) return <div className="h-full flex items-center justify-center text-white bg-gray-900">è¼‰å…¥ä¸­...</div>;
    const currentQ = questions[currentIndex];
    return (
        <div className="flex flex-col h-full bg-gray-100 text-gray-800">
            <div className="bg-gray-800 text-white p-4 flex justify-between items-center shadow-md">
                <div className="font-bold text-lg">{currentQ.type === 'listening' ? 'ğŸ§ è½åŠ›' : 'ğŸ“– é–±è®€'}</div>
                <div className={`font-mono text-xl font-bold ${timeLeft < 60 ? 'animate-timer' : 'text-green-400'}`}>{Math.floor(timeLeft / 60)}:{String(timeLeft % 60).padStart(2, '0')}</div>
            </div>
            <div className="w-full bg-gray-300 h-2"><div className="bg-blue-600 h-2 transition-all duration-300" style={{ width: `${((currentIndex) / questions.length) * 100}%` }}></div></div>
            <div className="flex-1 flex flex-col items-center justify-center p-6 text-center">
                <div className="mb-8 h-32 flex flex-col items-center justify-center w-full">{currentQ.type === 'listening' ? (<button onClick={() => window.playAudio(currentQ.thai)} className="w-24 h-24 rounded-full bg-yellow-100 border-4 border-yellow-400 flex items-center justify-center text-4xl shadow-lg hover:scale-105 transition active:scale-95">ğŸ”Š</button>) : (<h2 className="text-5xl font-bold text-gray-800">{currentQ.thai}</h2>)}</div>
                <div className="grid grid-cols-1 gap-3 w-full max-w-md">{options.map((opt, idx) => (<button key={idx} onClick={() => handleAnswer(opt.meaning)} className="p-4 bg-white border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 font-bold text-lg transition shadow-sm text-left flex items-center"><span className="bg-gray-100 text-gray-500 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">{String.fromCharCode(65 + idx)}</span>{opt.meaning}</button>))}</div>
            </div>
        </div>
    );
};

const ExamResultScreen = ({ results, onHome, isHistoryMode = false }) => {
    const score = results.filter(r => r.isCorrect).length;
    const passed = (Math.round((score / results.length) * 100)) >= 60; 
    return (
        <div className="h-full bg-gray-50 overflow-y-auto p-4 flex flex-col">
            <div className="max-w-2xl w-full mx-auto bg-white rounded-2xl shadow-lg overflow-hidden flex-1 flex flex-col">
                <div className={`p-8 text-center ${passed ? 'bg-green-600' : 'bg-red-600'} text-white relative`}>
                    {isHistoryMode && <div className="absolute top-2 left-2 bg-black/20 px-2 py-1 rounded text-xs">æ­·å²ç´€éŒ„</div>}
                    <h2 className="text-3xl font-bold mb-1">{passed ? 'é€šé' : 'æœªé€šé'}</h2>
                    <div className="text-6xl font-black mt-4 mb-2">{score} <span className="text-2xl font-normal opacity-70">/ {results.length}</span></div>
                    {!isHistoryMode && passed && <div className="inline-block bg-white/20 px-4 py-1 rounded-full text-sm font-bold animate-pulse">ğŸ‰ +100 XP</div>}
                </div>
                <div className="p-4 bg-gray-100 border-b flex justify-between items-center text-sm text-gray-500"><span>æª¢è¨ ({results.length}é¡Œ)</span><span>ğŸ”Š è½ç™¼éŸ³</span></div>
                <div className="p-4 overflow-y-auto flex-1 space-y-3">{results.map((r, idx) => (<div key={idx} className={`flex items-start gap-3 p-3 rounded-lg border ${r.isCorrect ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`}><button onClick={() => window.playAudio(r.question.thai)} className="mt-1 w-8 h-8 rounded-full bg-white border flex items-center justify-center shadow-sm hover:scale-110 transition text-gray-600">ğŸ”Š</button><div className="flex-1"><div className="text-gray-800 font-bold">{r.question.type === 'listening' ? 'ğŸ”Š è½åŠ›' : r.question.thai}</div><div className="text-sm mt-1"><div className="text-green-600 font-bold">âœ… {r.question.meaning} <span className="text-xs text-gray-400">({r.question.thai})</span></div>{!r.isCorrect && <div className="text-red-400 line-through">âŒ {r.userChoice}</div>}</div></div></div>))}</div>
                <div className="p-6 bg-gray-50 border-t text-center"><button onClick={onHome} className="px-8 py-3 bg-gray-800 text-white rounded-full font-bold shadow-lg">å›åˆ—è¡¨ / é¦–é </button></div>
            </div>
        </div>
    );
};

const AlphabetScreen = ({ onBack }) => {
    const { consonantData, vowelData } = window.getDB();
    const [tab, setTab] = useState('consonant'); 
    return (
        <div className="flex flex-col h-full max-w-3xl mx-auto p-4 bg-white">
            <div className="flex items-center justify-between mb-4">
                 <button onClick={onBack} className="text-gray-500 hover:bg-gray-100 px-3 py-1 rounded">â¬…ï¸ é¦–é </button>
                 <div className="bg-gray-200 p-1 rounded-lg flex text-sm">
                    <button onClick={() => setTab('consonant')} className={`px-4 py-1 rounded-md transition ${tab === 'consonant' ? 'bg-white shadow text-yellow-700 font-bold' : 'text-gray-500'}`}>å­éŸ³</button>
                    <button onClick={() => setTab('vowel')} className={`px-4 py-1 rounded-md transition ${tab === 'vowel' ? 'bg-white shadow text-yellow-700 font-bold' : 'text-gray-500'}`}>æ¯éŸ³</button>
                 </div>
            </div>
            <div className="flex-1 overflow-y-auto grid grid-cols-4 md:grid-cols-6 gap-2 pb-4 content-start">
                {tab === 'consonant' ? consonantData.map((item, idx) => (
                    <button key={idx} onClick={() => window.playAudio(item.char)} className={`p-2 rounded-xl border-2 flex flex-col items-center justify-center aspect-square hover:scale-105 transition shadow-sm class-${item.class}`}>
                        <span className="text-3xl font-bold mb-1">{item.char}</span><span className="text-[10px] opacity-70">{item.name}</span>
                    </button>
                )) : vowelData.map((item, idx) => (
                    <button key={idx} onClick={() => window.playAudio(item.char.replace(/-/g, 'à¸­'))} className={`p-2 rounded-xl border-2 flex flex-col items-center justify-center aspect-square hover:scale-105 transition shadow-sm vowel-${item.type}`}>
                        <span className="text-2xl font-bold mb-1">{item.char}</span><span className="text-[10px] opacity-70 text-center leading-tight">{item.name}</span>
                    </button>
                ))}
            </div>
        </div>
    );
};

const RulesScreen = ({ onBack }) => (
    <div className="max-w-4xl mx-auto h-full overflow-y-auto p-4 pb-10 bg-white">
        <button onClick={onBack} className="mb-4 text-gray-500 hover:bg-gray-100 px-3 py-1 rounded">â¬…ï¸ é¦–é </button>
        <div className="bg-white p-5 rounded-2xl shadow-sm mb-6 border border-gray-100">
            <h2 className="text-2xl font-bold text-gray-800 mb-2">1. æœ‰è²èª¿ç¬¦è™Ÿ</h2>
            <div className="overflow-x-auto">
                <table className="w-full text-sm text-center border-collapse">
                    <thead><tr className="bg-gray-100 text-gray-600"><th className="p-2 border">å­éŸ³</th><th className="p-2 border">à¹ˆ</th><th className="p-2 border">à¹‰</th><th className="p-2 border bg-yellow-50">à¹Š</th><th className="p-2 border bg-yellow-50">à¹‹</th></tr></thead>
                    <tbody>
                        <tr><td className="p-3 border font-bold text-green-600">ä¸­</td><td className="p-3 border">Low</td><td className="p-3 border">Falling</td><td className="p-3 border bg-green-50 font-bold">High</td><td className="p-3 border bg-green-50 font-bold">Rising</td></tr>
                        <tr><td className="p-3 border font-bold text-red-600">é«˜</td><td className="p-3 border">Low</td><td className="p-3 border">Falling</td><td className="p-3 border text-gray-300">-</td><td className="p-3 border text-gray-300">-</td></tr>
                        <tr><td className="p-3 border font-bold text-blue-600">ä½</td><td className="p-3 border font-bold text-purple-600">Falling</td><td className="p-3 border font-bold text-purple-600">High</td><td className="p-3 border text-gray-300">-</td><td className="p-3 border text-gray-300">-</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
);

// --- 3. ä¸»ç¨‹å¼è·¯ç”± ---
function App() {
    const [view, setView] = useState('home');
    const [examResults, setExamResults] = useState(null);
    const [examQCount, setExamQCount] = useState(20);
    const [historyRecordToView, setHistoryRecordToView] = useState(null);
    
    // æ–°å¢ï¼šæƒ…å¢ƒæŒ‘æˆ°çš„é¡Œæ•¸ç‹€æ…‹
    const [situationLimit, setSituationLimit] = useState(10);

    // XP ç³»çµ±
    const [xp, setXp] = useState(() => parseInt(localStorage.getItem('thai_xp') || 0));
    const level = Math.floor(xp / 100) + 1;
    const addXp = (amount) => {
        const newXp = xp + amount;
        setXp(newXp);
        localStorage.setItem('thai_xp', newXp.toString());
    };

    // å­˜æª”æ­·å²
    const saveExamHistory = (results, totalQuestions) => {
        const score = results.filter(r => r.isCorrect).length;
        const newRecord = { id: Date.now(), date: new Date().toISOString(), score, totalQuestions, results };
        const saved = localStorage.getItem('thai_exam_history');
        const history = saved ? JSON.parse(saved) : [];
        history.push(newRecord);
        localStorage.setItem('thai_exam_history', JSON.stringify(history));
    };

    // è€ƒè©¦æµç¨‹
    const startExam = (count) => { setExamQCount(count); setView('exam'); };
    const finishExam = (results, questions) => {
        const completeResults = [...results];
        if (results.length < questions.length) {
            for (let i = results.length; i < questions.length; i++) {
                completeResults.push({ question: questions[i], userChoice: 'é€¾æ™‚', isCorrect: false });
            }
        }
        saveExamHistory(completeResults, questions.length);
        const score = completeResults.filter(r => r.isCorrect).length;
        if ((score / questions.length) >= 0.6) addXp(100);
        setExamResults(completeResults);
        setView('examResult');
    };
    const viewRecord = (record) => { setHistoryRecordToView(record); setView('historyResult'); };

    return (
        <div className="h-full w-full max-w-md mx-auto bg-white shadow-2xl overflow-hidden">
            {/* é¦–é ï¼šè™•ç†ä¸åŒæŒ‰éˆ•çš„å°å‘ */}
            {view === 'home' && <HomeScreen onStart={(v) => {
                if (v === 'examIntro') setView('examIntro');
                else if (v === 'situation') setView('situationIntro'); // å°å‘æƒ…å¢ƒè¨­å®šé 
                else setView(v);
            }} xp={xp} level={level} />}

            {/* å­—æ¯è¡¨ & è¦å‰‡ & å–®å­—å¡ & å–®å­—ç¸½è¡¨ */}
            {view === 'alphabet' && <AlphabetScreen onBack={() => setView('home')} />}
            {view === 'rules' && <RulesScreen onBack={() => setView('home')} />}
            {view === 'learn' && <LearnScreen onBack={() => setView('home')} />}
            {view === 'vocabList' && <VocabListScreen onBack={() => setView('home')} />}
            
            {/* ç°¡å–®ç·´ç¿’ */}
            {view === 'quiz' && <PracticeQuizScreen onBack={() => setView('home')} addXp={addXp} />}
            
            {/* å¯¦æˆ°æ¨¡æ“¬è€ƒæµç¨‹ */}
            {view === 'examIntro' && <ExamIntroScreen onStart={startExam} onBack={() => setView('home')} />}
            {view === 'exam' && <ExamScreen questionCount={examQCount} onFinish={finishExam} />}
            {view === 'examResult' && <ExamResultScreen results={examResults} onHome={() => setView('home')} />}
            
            {/* æ­·å²ç´€éŒ„ */}
            {view === 'history' && <HistoryScreen onBack={() => setView('home')} onViewRecord={viewRecord} />}
            {view === 'historyResult' && <ExamResultScreen results={historyRecordToView.results} onHome={() => setView('history')} isHistoryMode={true} />}

            {/* æƒ…å¢ƒè½åŠ›æŒ‘æˆ°æµç¨‹ */}
            {view === 'situationIntro' && (
                <SituationIntroScreen 
                    onStart={(count) => {
                        setSituationLimit(count);
                        setView('situation');
                    }} 
                    onBack={() => setView('home')} 
                />
            )}
            {view === 'situation' && (
                <SituationScreen 
                    onBack={() => setView('home')} 
                    addXp={addXp} 
                    limit={situationLimit} 
                />
            )}
            
            {/* é–‹ç™¼è€…å·¥å…· (å¦‚æœæœ‰ä¿ç•™çš„è©±) */}
            {view === 'creator' && <VocabCreator onBack={() => setView('home')} />}
        </div>
    );
}
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
    </script>
</body>
</html>